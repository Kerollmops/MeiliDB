<!DOCTYPE html>
<html>

<head>
    <title>MeiliSearch</title>

    <style type="text/css">
        @font-face {
          font-family: MyHelvetica;
          src: local("Helvetica Neue"),
               local("HelveticaNeue"),
               url(MgOpenModernaRegular.ttf);
        }

        @font-face {
          font-family: MyHelvetica;
          src: local("Helvetica Neue Bold"),
               local("HelveticaNeue-Bold"),
               url(MgOpenModernaBold.ttf);
          font-weight: bold;
        }

        body { font-family: MyHelvetica, sans-serif; }

        #panel {
            max-width: 900px;
            margin: 30px auto;
            font-size: 1.4em;
            font-style: italic;
            color: #44566CDE;
        }

        #search {
            border: none;
            font-style: inherit;
            font-size: inherit;
            color: inherit;
            border-bottom: 1px solid;
        }

        #index {
            -moz-appearance: none;
            appearance: none;
            border: none;
            font-style: inherit;
            font-size: inherit;
            color: inherit;
            border-bottom: 1px solid;
        }

        #results {
            max-width: 900px;
            margin: 0 auto;
            list-style-type: decimal-leading-zero;
            list-style-position: inside;
            padding: 0;
        }

        .document {
            border: 1px solid #e6e6e6;
            padding: 20px 20px;
            background-color: #FCFCFC;
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(59, 64, 69, 0.04);
            color: #44566C;
            margin-bottom: 30px;
            display: flex;
        }

        .document ul {
            flex: 0 0 75%;
            max-width: 75%;
            padding: 0;
        }

        .document .image {
            max-width: 25%;
            flex: 0 0 25%;
            padding-left: 30px;
            box-sizing: border-box;
        }

        .document .image img {
            width: 100%;
        }

        .field {
            list-style-type: none;
            display: flex;
            flex-wrap: wrap;
        }

        .field:not(:last-child) {
            margin-bottom: 7px;
        }

        .attribute {
            flex: 0 0 25%;
            max-width: 25%;
            text-align: right;
            padding-right: 10px;
            box-sizing: border-box;
            text-transform: uppercase;
        }

        .content {
            max-width: 75%;
            flex: 0 0 75%;
            box-sizing: border-box;
            padding-left: 10px;
        }

        em {
            color: #F23C79;
            font-style: inherit;
            background-color: #F23C7921;
        }
    </style>
</head>

<body>
    <div id="panel">
        <p>I want to search for <input type="text" id="search" autofocus> in the index <select id="index"></select>.</p>
        <span id="time"></span>
    </div>

    <ul id="results">
        <!-- search results -->
    </ul>

    <script>
        function httpGet(theUrl) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", theUrl, false); // false for synchronous request
            xmlHttp.send(null);
            return xmlHttp.responseText;
        }

        let lastRequest = undefined;

        function triggerSearch() {
            var e = document.getElementById("index");
            if (e.selectedIndex == -1) { return }
            var index = e.options[e.selectedIndex].value;

            let theUrl = `${baseUrl}/indexes/${index}/search?q=${search.value}&attributesToHighlight=*`;

            if (lastRequest) { lastRequest.abort() }
            lastRequest = new XMLHttpRequest();

            lastRequest.open("GET", theUrl, true);
            lastRequest.onload = function (e) {
                if (lastRequest.readyState === 4 && lastRequest.status === 200) {
                    let httpResults = JSON.parse(lastRequest.responseText);
                    results.innerHTML = '';

                    let processingTimeMs = httpResults.processingTimeMs;
                    let numberOfDocuments = httpResults.hits.length;
                    time.innerHTML = `We found ${numberOfDocuments} documents in ${processingTimeMs}ms`;

                    for (result of httpResults.hits) {
                        const element = {...result, ...result._formatted };
                        delete element._formatted;

                        const elem = document.createElement('li');
                        elem.classList.add("document");

                        const ul = document.createElement('ul');
                        let image = undefined;

                        for (const prop in element) {
                            // Check if property is an image url link.
                            if (typeof result[prop] === 'string') {
                                if (image == undefined && result[prop].match(/^(https|http):\/\/.*(jpe?g|png|gif)(\?.*)?$/g)) {
                                    image = result[prop];
                                }
                            }

                            const field = document.createElement('li');
                            field.classList.add("field");

                            const attribute = document.createElement('div');
                            attribute.classList.add("attribute");
                            attribute.innerHTML = prop;

                            const content = document.createElement('div');
                            content.classList.add("content");
                            content.innerHTML = element[prop];

                            field.appendChild(attribute);
                            field.appendChild(content);

                            ul.appendChild(field);
                        }

                        elem.appendChild(ul);

                        if (image != undefined) {
                            const div = document.createElement('div');
                            div.classList.add("image");

                            const img = document.createElement('img');
                            img.src = image;

                            div.appendChild(img);
                            elem.appendChild(div);
                        }

                        results.appendChild(elem)
                    }
                } else {
                    console.error(lastRequest.statusText);
                }
            };
            lastRequest.send(null);
        }

        let baseUrl = window.location.origin;
        // TODO we must not block here
        let result = JSON.parse(httpGet(`${baseUrl}/indexes`));

        let select = document.getElementById("index");
        for (index of result) {
            const option = document.createElement('option');
            option.value = index.uid;
            option.innerHTML = index.name;
            select.appendChild(option);
        }

        search.oninput = triggerSearch;
        select.onchange = triggerSearch;

        triggerSearch();
    </script>
</body>

</html>
