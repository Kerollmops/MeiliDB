<!DOCTYPE html>
<html>

<head>
    <title>MeiliSearch</title>

    <style type="text/css">
        @font-face {
          font-family: MyHelvetica;
          src: local("Helvetica Neue"),
               local("HelveticaNeue"),
               url(MgOpenModernaRegular.ttf);
        }

        @font-face {
          font-family: MyHelvetica;
          src: local("Helvetica Neue Bold"),
               local("HelveticaNeue-Bold"),
               url(MgOpenModernaBold.ttf);
          font-weight: bold;
        }

        body { font-family: MyHelvetica, sans-serif; }

        #panel {
            max-width: 900px;
            margin: 30px auto;
        }

        #results {
            max-width: 900px;
            margin: 0 auto;
            list-style-type: decimal-leading-zero;
            list-style-position: inside;
            padding: 0;
        }

        .document {
            border: 1px solid #e6e6e6;
            padding: 20px 20px;
            background-color: #FCFCFC;
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(59, 64, 69, 0.04);
            color: #44566C;
            margin-bottom: 30px;
        }

        .field {
            list-style-type: none;
            display: flex;
            flex-wrap: wrap;
        }

        .field:not(:last-child) {
            margin-bottom: 7px;
        }

        .attribute {
            flex: 0 0 15%;
            max-width: 15%;
            text-align: right;
            padding-right: 10px;
            box-sizing: border-box;
            text-transform: uppercase;
        }

        .content {
            max-width: 85%;
            flex: 0 0 85%;
            box-sizing: border-box;
            padding-left: 10px;
        }

        em {
            color: #F23C79;
            font-style: inherit;
            background-color: #F23C7921;
        }
    </style>
</head>

<body>
    <div id="panel">
        <select id="index">
            <!-- indexes names -->
        </select>

        <input type="text" id="search" autofocus>

        <span id="time"></span>
    </div>

    <ul id="results">
        <!-- search results -->
    </ul>

    <script>
        function httpGet(theUrl) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", theUrl, false); // false for synchronous request
            xmlHttp.send(null);
            return xmlHttp.responseText;
        }

        function triggerSearch() {
            // TODO onchange would be a better fit
            var e = document.getElementById("index");
            var index = e.options[e.selectedIndex].value;

            let theUrl = `${baseUrl}/indexes/${index}/search?q=${search.value}&attributesToHighlight=*`;
            var xhr = new XMLHttpRequest();
            xhr.open("GET", theUrl, true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    let httpResults = JSON.parse(xhr.responseText);
                    results.innerHTML = '';

                    let processingTimeMs = httpResults.processingTimeMs;
                    let numberOfDocuments = httpResults.hits.length;
                    time.innerHTML = `found ${numberOfDocuments} documents in ${processingTimeMs}ms`;

                    for (result of httpResults.hits) {
                        const element = {...result, ...result._formatted };
                        delete element._formatted;

                        const elem = document.createElement('li');
                        elem.classList.add("document");

                        const ul = document.createElement('ul');

                        for (const prop in element) {
                            const li = document.createElement('li');
                            li.classList.add("field");

                            li.innerHTML = `<div class="attribute">${prop}</div><div class="content">${element[prop]}</div>`;
                            ul.appendChild(li);
                        }

                        elem.appendChild(ul);
                        results.appendChild(elem)
                    }
                } else {
                    console.error(xhr.statusText);
                }
            };
            xhr.send(null);
        }

        let baseUrl = window.location.origin;
        let result = JSON.parse(httpGet(`${baseUrl}/indexes`));

        let select = document.getElementById("index");
        for (index of result) {
            const option = document.createElement('option');
            option.value = index.uid;
            option.innerHTML = index.name;
            select.appendChild(option);
        }

        search.oninput = triggerSearch;
        select.onchange = triggerSearch;

        triggerSearch();
    </script>
</body>

</html>
